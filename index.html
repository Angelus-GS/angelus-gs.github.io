<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gorilla Gains">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="Serious Steel Fitness — Track your push and pull workouts with resistance bands.">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
    <title>Gorilla Gains</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            padding-top: env(safe-area-inset-top);
            background-color: #f8fafc;
            overflow-x: hidden;
        }
        .btn-press:active { transform: scale(0.97); opacity: 0.8; }
        .modal-overlay { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px); }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 1.5rem; background: #000; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .toast {
            position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 1.5rem; font-size: 11px; font-weight: 800;
            text-transform: uppercase; letter-spacing: 0.05em; z-index: 200;
            animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
        }
        .toast-success { background: #059669; color: white; }
        .toast-error { background: #dc2626; color: white; }
        .toast-info { background: #0f172a; color: white; }
        @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        @keyframes toastOut { from { opacity: 1; } to { opacity: 0; } }
        .spinner { display: inline-block; width: 16px; height: 16px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="select-none">
    <div id="app" class="max-w-md mx-auto min-h-screen relative pb-32"></div>

    <!-- Video Modal -->
    <div id="videoModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="modal-overlay absolute inset-0" onclick="closeVideo()"></div>
        <div class="relative w-full max-w-lg animate-in zoom-in-95 duration-200">
            <button onclick="closeVideo()" class="absolute -top-10 right-0 text-white font-black uppercase text-xs tracking-widest flex items-center gap-2">
                Close <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
            <div id="videoTarget" class="video-container shadow-2xl"></div>
        </div>
    </div>

    <input type="file" id="importFile" accept=".json" class="hidden" onchange="handleImport(event)">

    <script>
        // =============================================
        // GOOGLE DRIVE CONFIG
        // =============================================
        const CLIENT_ID = '336608207955-454je6ofcqka7cu0mlv4vpoc2h65fmgr.apps.googleusercontent.com';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.appdata';
        const BACKUP_FILENAME = 'gorilla-gains-backup.json';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let driveReady = false;

        function gapiLoaded() {
            gapi.load('client', async () => {
                await gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] });
                gapiInited = true;
                checkDriveReady();
            });
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gisInited = true;
            checkDriveReady();
        }

        function checkDriveReady() {
            driveReady = gapiInited && gisInited;
            if (state.view === 'settings') render();
            if (driveReady) {
                // Attempt auto-sync when Drive becomes ready
                autoSyncOnLaunch();
            }
        }

        // Request Google authorization, then run callback
        function withDriveAuth(callback) {
            // If we already have a valid token, just run the callback directly
            if (gapi.client.getToken() !== null) {
                callback();
                return;
            }
            // Otherwise, request a new token (first time only)
            tokenClient.callback = async (resp) => {
                if (resp.error) {
                    showToast('Google sign-in failed', 'error');
                    return;
                }
                await callback();
            };
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        // Find existing backup file in appDataFolder
        async function findBackupFile() {
            const response = await gapi.client.drive.files.list({
                spaces: 'appDataFolder',
                fields: 'files(id, name, modifiedTime)',
                q: `name = '${BACKUP_FILENAME}'`
            });
            return response.result.files && response.result.files.length > 0
                ? response.result.files[0]
                : null;
        }

        // Save data to Google Drive appDataFolder
        async function saveToDrive(silent = false) {
            if (!silent) showToast('Saving to Google Drive...', 'info');
            try {
                const existing = await findBackupFile();

                // Safety check: prevent overwriting cloud backup with empty local data
                if (state.logs.length === 0 && existing) {
                    if (silent) return; // Auto-save: skip silently
                    if (!confirm('Your local data is empty but you have a backup on Google Drive. Saving will overwrite it with nothing.\n\nDid you mean to Load from Drive instead?')) {
                        return;
                    }
                }
                const fileContent = JSON.stringify(state.logs, null, 2);
                const metadata = {
                    name: BACKUP_FILENAME,
                    mimeType: 'application/json',
                };

                const boundary = '-------314159265358979323846';
                const delimiter = '\r\n--' + boundary + '\r\n';
                const closeDelimiter = '\r\n--' + boundary + '--';

                if (existing) {
                    // Update existing file
                    const multipartBody =
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        JSON.stringify({ mimeType: 'application/json' }) +
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        fileContent +
                        closeDelimiter;

                    await gapi.client.request({
                        path: `/upload/drive/v3/files/${existing.id}`,
                        method: 'PATCH',
                        params: { uploadType: 'multipart' },
                        headers: { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' },
                        body: multipartBody,
                    });
                } else {
                    // Create new file
                    metadata.parents = ['appDataFolder'];
                    const multipartBody =
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        JSON.stringify(metadata) +
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        fileContent +
                        closeDelimiter;

                    await gapi.client.request({
                        path: '/upload/drive/v3/files',
                        method: 'POST',
                        params: { uploadType: 'multipart' },
                        headers: { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' },
                        body: multipartBody,
                    });
                }

                localStorage.setItem('gorilla_lastDriveSync', new Date().toISOString());
                showToast('Saved to Google Drive!', 'success');
                render();
            } catch (err) {
                console.error('Drive save error:', err);
                showToast('Failed to save to Drive', 'error');
            }
        }

        // Load data from Google Drive appDataFolder
        async function loadFromDrive() {
            showToast('Loading from Google Drive...', 'info');
            try {
                const file = await findBackupFile();
                if (!file) {
                    showToast('No backup found on Drive', 'error');
                    return;
                }

                const response = await gapi.client.drive.files.get({
                    fileId: file.id,
                    alt: 'media'
                });

                const importedLogs = typeof response.result === 'string'
                    ? JSON.parse(response.result)
                    : response.result;

                if (Array.isArray(importedLogs)) {
                    state.logs = importedLogs;
                    localStorage.setItem('gorilla_v1_final', JSON.stringify(state.logs));
                    localStorage.setItem('gorilla_lastDriveSync', new Date().toISOString());
                    showToast(`Loaded ${importedLogs.length} workouts from Drive!`, 'success');
                    render();
                } else {
                    showToast('Invalid backup data on Drive', 'error');
                }
            } catch (err) {
                console.error('Drive load error:', err);
                showToast('Failed to load from Drive', 'error');
            }
        }

        // Auto-save to Drive silently (no prompts, only if already signed in)
        async function autoSaveToDrive() {
            if (!driveReady || !isGoogleSignedIn()) return;
            if (state.logs.length === 0) return; // Never auto-save empty data
            try {
                await saveToDrive(true);
            } catch (err) {
                console.error('Auto-save to Drive failed:', err);
            }
        }

        // Auto-sync on app launch: compare local vs cloud timestamps
        async function autoSyncOnLaunch() {
            if (!driveReady || !isGoogleSignedIn()) return;
            try {
                const file = await findBackupFile();
                if (!file) {
                    // No cloud backup exists yet — upload local data
                    if (state.logs.length > 0) {
                        await saveToDrive();
                    }
                    return;
                }

                const cloudModified = new Date(file.modifiedTime).getTime();
                const localModified = localStorage.getItem('gorilla_localModified');
                const localTime = localModified ? new Date(localModified).getTime() : 0;

                // After reinstall: no local timestamp and empty logs — always load from cloud
                if (state.logs.length === 0 && !localModified) {
                    const response = await gapi.client.drive.files.get({
                        fileId: file.id,
                        alt: 'media'
                    });
                    const importedLogs = typeof response.result === 'string'
                        ? JSON.parse(response.result)
                        : response.result;
                    if (Array.isArray(importedLogs) && importedLogs.length > 0) {
                        state.logs = importedLogs;
                        localStorage.setItem('gorilla_v1_final', JSON.stringify(state.logs));
                        localStorage.setItem('gorilla_lastDriveSync', new Date().toISOString());
                        localStorage.setItem('gorilla_localModified', file.modifiedTime);
                        showToast(`Restored ${importedLogs.length} workouts from Drive`, 'success');
                        render();
                    }
                    return;
                }

                if (cloudModified > localTime) {
                    // Cloud is newer — load from Drive
                    const response = await gapi.client.drive.files.get({
                        fileId: file.id,
                        alt: 'media'
                    });
                    const importedLogs = typeof response.result === 'string'
                        ? JSON.parse(response.result)
                        : response.result;
                    if (Array.isArray(importedLogs)) {
                        state.logs = importedLogs;
                        localStorage.setItem('gorilla_v1_final', JSON.stringify(state.logs));
                        localStorage.setItem('gorilla_lastDriveSync', new Date().toISOString());
                        localStorage.setItem('gorilla_localModified', file.modifiedTime);
                        showToast('Synced from Google Drive', 'success');
                        render();
                    }
                } else if (localTime > cloudModified) {
                    // Local is newer — push to Drive
                    await saveToDrive();
                }
                // If equal, do nothing
            } catch (err) {
                console.error('Auto-sync failed:', err);
            }
        }

        // Sign out of Google
        function signOutGoogle() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                showToast('Signed out of Google', 'info');
                render();
            }
        }

        function isGoogleSignedIn() {
            return gapi.client && gapi.client.getToken() !== null;
        }

        // Toast notification
        function showToast(message, type = 'info') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // =============================================
        // APP STATE & CORE LOGIC
        // =============================================
        const EXERCISE_DATA = {
            'Chest Press': { url: '5X_gPGYWYuA', optional: false },
            'Overhead Press': { url: '85C75KNm7Qo', optional: false },
            'Tricep Extension': { url: 'SMRkz6vuBe0', optional: false },
            'Front Squats': { url: 'Ewrkp3n2_ak', optional: false },
            'Back Squats': { url: 'nB5DgxZgy0U', optional: true },
            'Split Squat (Static Lunge)': { url: '_n8RtIIXzp0', optional: true },
            'Romanian Deadlift': { url: '2YNi18sXZtI', optional: false },
            'Bent-Over Rows': { url: 'XByIBZGh0V0', optional: false },
            'Bicep Curls': { url: 'WPbCeZAtOaA', optional: false },
            'Calf Raises': { url: 'mu54xsdYmmE', optional: false },
            'Shrugs': { url: '-wFZjHB8zxE', optional: true }
        };

        const WORKOUTS = {
            PUSH: ['Chest Press', 'Overhead Press', 'Tricep Extension', 'Front Squats', 'Back Squats', 'Split Squat (Static Lunge)'],
            PULL: ['Romanian Deadlift', 'Bent-Over Rows', 'Bicep Curls', 'Calf Raises', 'Shrugs']
        };

        const BANDS = [
            { name: '#0 Orange', color: '#ff8c00' }, { name: '#1 Purple', color: '#800080' },
            { name: '#2 Red', color: '#ff0000' }, { name: '#3 Blue', color: '#0000ff' },
            { name: '#4 Green', color: '#008000' }, { name: '#5 Black', color: '#000000' },
            { name: '#6 Yellow', color: '#ffff00' }
        ];

        let state = {
            view: 'dashboard',
            logs: JSON.parse(localStorage.getItem('gorilla_v1_final') || '[]'),
            currentWorkout: null
        };

        function saveLocal() {
            localStorage.setItem('gorilla_v1_final', JSON.stringify(state.logs));
            localStorage.setItem('gorilla_localModified', new Date().toISOString());
            render();
        }

        function openVideo(videoId) {
            const target = document.getElementById('videoTarget');
            target.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?rel=0&autoplay=1&playsinline=1" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
            document.getElementById('videoModal').classList.remove('hidden');
        }

        function closeVideo() {
            document.getElementById('videoModal').classList.add('hidden');
            document.getElementById('videoTarget').innerHTML = '';
        }

        function calculateNextIntensity() {
            if (state.logs.length === 0) return 'MEDIUM';
            const cycle = ['LIGHT', 'MEDIUM', 'HEAVY'];
            const last = state.logs[0].intensity;
            return cycle[(cycle.indexOf(last) + 1) % 3];
        }

        function finishWorkout() {
            state.logs.unshift(state.currentWorkout);
            state.view = 'dashboard';
            saveLocal();
            // Auto-save to Google Drive in the background
            autoSaveToDrive();
        }

        function startWorkout(type) {
            state.currentWorkout = {
                id: Date.now(),
                date: new Date().toISOString(),
                type,
                intensity: calculateNextIntensity(),
                exercises: WORKOUTS[type].map(name => ({
                    name, reps: '', bands: [], setup: 'Doubled', completed: false, 
                    optional: EXERCISE_DATA[name]?.optional || false,
                    vid: EXERCISE_DATA[name]?.url || ''
                }))
            };
            state.view = 'workout';
            window.scrollTo(0,0);
            render();
        }

        function exportData() {
            const dataStr = JSON.stringify(state.logs, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `gorilla-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function triggerImport() { document.getElementById('importFile').click(); }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedLogs = JSON.parse(e.target.result);
                    if (confirm(`Import ${importedLogs.length} workouts?`)) {
                        state.logs = importedLogs;
                        saveLocal();
                    }
                } catch (err) { alert("Invalid file."); }
            };
            reader.readAsText(file);
        }

        // =============================================
        // RENDERING
        // =============================================
        function render() {
            const app = document.getElementById('app');
            if (state.view === 'dashboard') renderDashboard(app);
            else if (state.view === 'workout') renderWorkout(app);
            else if (state.view === 'history') renderHistory(app);
            else if (state.view === 'settings') renderSettings(app);
            renderNav(app);
        }

        function renderDashboard(app) {
            app.innerHTML = `
                <div class="p-6 pt-12 space-y-8 animate-in fade-in duration-500">
                    <header>
                        <h1 class="text-5xl font-black italic tracking-tighter leading-none text-slate-900">GORILLA<br>GAINS</h1>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-2">Serious Steel Fitness</p>
                    </header>
                    <div class="space-y-4">
                        <button onclick="startWorkout('PUSH')" class="btn-press w-full bg-slate-900 text-white p-8 rounded-[2.5rem] text-left shadow-2xl">
                            <p class="text-2xl font-black italic uppercase">Push Session</p>
                            <p class="text-[10px] font-bold opacity-40 uppercase tracking-widest leading-relaxed mt-1">Chest • Delts • Triceps • Quads</p>
                        </button>
                        <button onclick="startWorkout('PULL')" class="btn-press w-full bg-white border-2 border-slate-100 text-slate-900 p-8 rounded-[2.5rem] text-left shadow-sm">
                            <p class="text-2xl font-black italic uppercase">Pull Session</p>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest leading-relaxed mt-1">Back • Hams • Biceps • Traps</p>
                        </button>
                    </div>
                    <div class="bg-blue-600 text-white p-6 rounded-[2rem] shadow-lg shadow-blue-100 flex justify-between items-center">
                        <div>
                            <p class="text-[10px] font-black uppercase opacity-60 tracking-widest">Next Target:</p>
                            <p class="text-xl font-black italic uppercase leading-none">${calculateNextIntensity()}</p>
                        </div>
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" class="opacity-50"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                    </div>
                </div>`;
        }

        function renderWorkout(app) {
            const wk = state.currentWorkout;
            app.innerHTML = `
                <div class="bg-white/90 backdrop-blur-md sticky top-0 z-50 p-6 flex justify-between items-center border-b border-slate-100">
                    <button onclick="state.view='dashboard'; render()" class="text-xs font-black text-slate-400 uppercase">Exit</button>
                    <div class="text-center">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-tighter">${wk.intensity} PHASE</p>
                        <p class="font-black italic uppercase leading-none text-slate-900">${wk.type}</p>
                    </div>
                    <button onclick="finishWorkout()" class="bg-slate-900 text-white px-5 py-2 rounded-2xl text-xs font-black italic uppercase">Save</button>
                </div>
                <div class="p-4 space-y-4">
                    ${wk.exercises.map((ex, idx) => `
                        <div class="bg-white p-6 rounded-[2.5rem] border ${ex.completed ? 'border-emerald-500 bg-emerald-50/10' : 'border-slate-100 shadow-sm'}">
                            <div class="flex justify-between items-start mb-4">
                                <div class="w-3/4">
                                    <div class="flex items-center gap-2">
                                        <h3 class="font-black italic uppercase text-lg leading-tight text-slate-900">${ex.name}</h3>
                                        <button onclick="openVideo('${ex.vid}')" class="text-blue-500 active:scale-90 p-1">
                                            <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M10 15l5.19-3L10 9v6z"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                                        </button>
                                    </div>
                                    ${ex.optional ? '<p class="text-[9px] font-black text-amber-500 uppercase tracking-widest mt-1">Optional Exercise</p>' : ''}
                                </div>
                                <input type="checkbox" ${ex.completed ? 'checked' : ''} onchange="state.currentWorkout.exercises[${idx}].completed = this.checked; render()" class="w-8 h-8 rounded-full border-2 border-slate-200 accent-emerald-500">
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <button onclick="state.currentWorkout.exercises[${idx}].setup = (state.currentWorkout.exercises[${idx}].setup === 'Doubled' ? 'Singled' : 'Doubled'); render()" class="bg-slate-50 p-3 rounded-2xl text-[10px] font-black uppercase italic text-slate-500">${ex.setup}</button>
                                <input type="number" inputmode="numeric" value="${ex.reps}" oninput="state.currentWorkout.exercises[${idx}].reps = this.value" class="bg-slate-50 p-3 rounded-2xl text-center font-black italic text-slate-900" placeholder="REPS">
                            </div>
                            <div class="flex flex-wrap gap-2">
                                ${BANDS.map(b => `
                                    <button onclick="const bds = state.currentWorkout.exercises[${idx}].bands; state.currentWorkout.exercises[${idx}].bands = bds.includes('${b.name}') ? bds.filter(n => n !== '${b.name}') : [...bds, '${b.name}']; render()" class="px-3 py-2 rounded-xl text-[9px] font-black border-2 transition-all ${ex.bands.includes(b.name) ? 'bg-slate-900 text-white border-slate-900' : 'bg-white text-slate-300 border-slate-50'}">
                                        ${b.name.split(' ')[1]}
                                    </button>
                                `).join('')}
                            </div>
                        </div>`).join('')}
                </div>`;
        }

        function renderHistory(app) {
            app.innerHTML = `
                <div class="p-6 pt-12 animate-in slide-in-from-bottom-4 duration-500">
                    <h1 class="text-4xl font-black italic uppercase tracking-tighter mb-8 text-slate-900">History</h1>
                    <div class="space-y-4">
                        ${state.logs.length === 0 ? '<p class="text-slate-300 font-bold italic">No sessions found.</p>' : ''}
                        ${state.logs.map((log, i) => `
                            <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm relative overflow-hidden">
                                <div class="absolute left-0 top-0 bottom-0 w-1.5 ${log.intensity === 'HEAVY' ? 'bg-red-500' : log.intensity === 'MEDIUM' ? 'bg-blue-500' : 'bg-emerald-500'}"></div>
                                <div class="flex justify-between items-start mb-4">
                                    <div><p class="font-black italic uppercase text-sm text-slate-900">${log.type}</p><p class="text-[10px] font-bold text-slate-400 mt-1">${new Date(log.date).toLocaleDateString()}</p></div>
                                    <button onclick="if(confirm('Delete?')){state.logs.splice(${i},1); saveLocal()}" class="text-slate-200"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M3 6h18m-2 0v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/></svg></button>
                                </div>
                                <div class="space-y-1">
                                    ${log.exercises.filter(ex => ex.completed).map(ex => `<div class="flex justify-between items-center text-[10px] font-bold uppercase italic"><span class="text-slate-400">${ex.name}</span><span class="text-slate-900">${ex.reps} REPS</span></div>`).join('')}
                                </div>
                            </div>`).join('')}
                    </div>
                </div>`;
        }

        function renderSettings(app) {
            const lastSync = localStorage.getItem('gorilla_lastDriveSync');
            const lastSyncText = lastSync
                ? new Date(lastSync).toLocaleDateString() + ' ' + new Date(lastSync).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                : 'Never';
            const signedIn = isGoogleSignedIn();

            app.innerHTML = `
                <div class="p-6 pt-12">
                    <h1 class="text-4xl font-black italic mb-8 uppercase tracking-tighter leading-none text-slate-900">Cloud<br>Backup</h1>
                    <div class="space-y-6">

                        <!-- Google Drive Section -->
                        <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm text-center">
                            <div class="w-16 h-16 bg-blue-600 text-white rounded-3xl flex items-center justify-center mx-auto mb-4">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/><path d="M12 18v-6"/><path d="M9 15l3-3 3 3"/></svg>
                            </div>
                            <h2 class="text-xl font-black italic uppercase mb-1 text-slate-900">Google Drive</h2>
                            <p class="text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-widest leading-relaxed">Sync across all devices</p>
                            <p class="text-[10px] font-bold text-slate-300 mb-6">Last sync: ${lastSyncText}</p>
                            ${driveReady ? `
                                <div class="space-y-3">
                                    <button onclick="withDriveAuth(saveToDrive)" class="btn-press w-full bg-blue-600 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-widest italic">
                                        <svg class="inline-block mr-2 -mt-0.5" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m4-5 5 5 5-5m-5 5V3"/></svg>
                                        Save to Drive
                                    </button>
                                    <button onclick="withDriveAuth(loadFromDrive)" class="btn-press w-full bg-white border-2 border-blue-600 text-blue-600 py-4 rounded-2xl font-black text-xs uppercase tracking-widest italic">
                                        <svg class="inline-block mr-2 -mt-0.5" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m14-7-5-5-5 5m5-5v12"/></svg>
                                        Load from Drive
                                    </button>
                                    ${signedIn ? `
                                        <button onclick="signOutGoogle()" class="w-full text-slate-300 py-2 text-[10px] font-black uppercase tracking-widest">Sign out of Google</button>
                                    ` : ''}
                                </div>
                            ` : `
                                <div class="bg-slate-50 p-4 rounded-2xl">
                                    <p class="text-[10px] font-bold text-slate-400 italic">Loading Google Drive...</p>
                                    <div class="spinner mt-2" style="border-color: rgba(0,0,0,0.1); border-top-color: #64748b;"></div>
                                </div>
                            `}
                        </div>

                        <!-- Divider -->
                        <div class="flex items-center gap-4">
                            <div class="flex-1 h-px bg-slate-100"></div>
                            <p class="text-[9px] font-black text-slate-300 uppercase tracking-widest">Or use files</p>
                            <div class="flex-1 h-px bg-slate-100"></div>
                        </div>

                        <!-- Manual Export -->
                        <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm text-center">
                            <div class="w-16 h-16 bg-slate-900 text-white rounded-3xl flex items-center justify-center mx-auto mb-4"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m4-5 5 5 5-5m-5 5V3"/></svg></div>
                            <h2 class="text-xl font-black italic uppercase mb-1 text-slate-900">Export File</h2>
                            <p class="text-[10px] font-bold text-slate-400 mb-6 uppercase tracking-widest leading-relaxed">Download JSON backup</p>
                            <button onclick="exportData()" class="btn-press w-full bg-slate-900 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-widest italic">Download Backup</button>
                        </div>

                        <!-- Manual Import -->
                        <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm text-center">
                            <div class="w-16 h-16 bg-slate-500 text-white rounded-3xl flex items-center justify-center mx-auto mb-4"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m14-7-5-5-5 5m5-5v12"/></svg></div>
                            <h2 class="text-xl font-black italic uppercase mb-1 text-slate-900">Import File</h2>
                            <p class="text-[10px] font-bold text-slate-400 mb-6 uppercase tracking-widest leading-relaxed">Restore from JSON file</p>
                            <button onclick="triggerImport()" class="btn-press w-full bg-slate-500 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-widest italic">Upload Backup</button>
                        </div>

                    </div>
                </div>`;
        }

        function renderNav(app) {
            if (state.view === 'workout') return;
            const nav = document.createElement('nav');
            nav.className = "fixed bottom-8 left-1/2 -translate-x-1/2 w-[90%] bg-white/80 backdrop-blur-2xl border border-white/50 p-2 flex justify-around rounded-[2.5rem] shadow-2xl z-50";
            nav.innerHTML = `
                <button onclick="state.view='dashboard'; render()" class="p-4 ${state.view === 'dashboard' ? 'text-slate-900' : 'text-slate-300'} transition-colors"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg></button>
                <button onclick="state.view='history'; render()" class="p-4 ${state.view === 'history' ? 'text-slate-900' : 'text-slate-300'} transition-colors"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg></button>
                <button onclick="state.view='settings'; render()" class="p-4 ${state.view === 'settings' ? 'text-slate-900' : 'text-slate-300'} transition-colors"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg></button>
            `;
            app.appendChild(nav);
        }

        render();

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((reg) => console.log('Service Worker registered:', reg.scope))
                    .catch((err) => console.log('Service Worker registration failed:', err));
            });
        }
    </script>
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
